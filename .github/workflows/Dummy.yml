name: deploy to dummy

on:
  workflow_dispatch:

  push:
   branches: [ "Patch4" ]


jobs:
  download:
    runs-on: windows-latest
    steps:
      - name: Download Latest from develop
        uses: dawidd6/action-download-artifact@v6
        with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
         workflow: build.yml
         branch: Patch3
         name: drop
         name_is_regexp: true

      - name: Get Runner IP
        id: ip
        shell: pwsh
        run: |
          $ip = curl -s https://api.ipify.org
          $ip6 = (curl -s https://api64.ipify.org || true)
          echo "ipv4=$ip" >> $env:GITHUB_OUTPUT
          echo "ipv6=$ip6" >> $env:GITHUB_OUTPUT

      - name: View the IPV6 Address
        run: echo "The GitHub Runner IP is ${{ steps.ip.outputs.ipv6 }}"

      - name: View the IP Address
        run: echo "The GitHub Runner IP is ${{ steps.ip.outputs.ipv4 }}"


      
      - name: Debug download structure
        run: |
         echo "=== What was downloaded? ==="
         $dropDir = Get-ChildItem -Path "${{ github.workspace }}\drop-*" -Directory | Select-Object -First 1
         echo "Drop directory: $($dropDir.FullName)"
         echo "`n=== Tree structure ==="
         Get-ChildItem -Path $dropDir.FullName -Recurse | 
         Select-Object -First 20 | 
         ForEach-Object {
         $depth = ($_.FullName -split '\\').Count - ($dropDir.FullName -split '\\').Count
         $indent = "  " * $depth
         if ($_.PSIsContainer) {
           echo "${indent}[$($_.Name)]"
         } else {
           echo "${indent}$($_.Name)"
         }
         }  

      - name: Copy to fixed folder
        run: |
         $dropDir = Get-ChildItem -Path "${{ github.workspace }}\drop-*" -Directory | Select-Object -First 1
         Copy-Item -Path $dropDir -Destination "${{ github.workspace }}\deploy" -Recurse -Force
    
         echo "Copied to: ${{ github.workspace }}\deploy"

      - name: Debug copy result
        run: |
         echo "=== What was copied? ==="
         echo "Deploy folder: ${{ github.workspace }}\deploy"
         Get-ChildItem -Path "${{ github.workspace }}\deploy" -Recurse | 
         Select-Object -First 20 | 
         ForEach-Object {
         $depth = ($_.FullName -split '\\').Count - ("${{ github.workspace }}\deploy" -split '\\').Count
         $indent = "  " * $depth
         if ($_.PSIsContainer) {
         echo "${indent}[$($_.Name)]"
         } else {
          echo "${indent}$($_.Name)"
         }
         }

      - name: List files
        run: |
         dir "${{ github.workspace }}/deploy/Release/netcoreapp2.1"     

      - name: List downloaded files
        run: |
         Write-Host "=== FILES IN drop-12 ===" -ForegroundColor Green
         Get-ChildItem drop-12 -Recurse | ForEach-Object {
         Write-Host $_.FullName
         }
